#! /usr/bin/env node

const { resolve } = require('path')
const getConfig = require('../dist/config')
const parseArgs = require('minimist')
const buildApp = require('next/dist/server/build').default
const exportApp = require('next/dist/server/export').default
const { PHASE_PRODUCTION_BUILD } = require('next/constants')

const argv = parseArgs(process.argv.slice(2))
const dir = resolve(argv._[0] || '.')
const config = getConfig(dir, PHASE_PRODUCTION_BUILD)

buildApp(dir, config)
.then(() => config.static
  ? exportApp(dir, {outdir: resolve(dir, 'out')}, config)
  : Promise.resolve()
)
.catch(err => {
  console.error(err)
  process.exit(1)
})
